import{s as U}from"./snackbar-BTqzwliu.js";import{p as C,s as P}from"./index-BNH3mZEl.js";import{x as z,u as S,_ as E,f as _,o as u,a,w as t,b as m,e as s,t as c,c as p,h as f,g as M,F as x,r as F}from"./index-2CK1TBd1.js";import{L as N}from"./location.service-DKpUiO2x.js";import{C as R,B as L,U as B,P as h}from"./product.service-6MmcmfrT.js";import{S as O}from"./supplier.service-OgXXiTCw.js";import{b as w}from"./route-block-B_A1xBdJ.js";import{V as y,a as d,b as A,h as T,d as V,c as Y,i as j,f as Q}from"./VCard-C0Nnn3PC.js";import{a as b,V as g}from"./VTextField-Dl59xlA2.js";import{V as W}from"./VForm-B5T0w2Cq.js";import{V as k}from"./VAlert-B24Zed_l.js";import{V as I}from"./VChip-ijcJUYKv.js";import{V as D}from"./VAutocomplete-D3vxxXeM.js";import{V as G}from"./VCheckbox-CZ8kdPZl.js";import{V as H}from"./VSwitch-WVqAYBdJ.js";import{V as J}from"./VSnackbar-Dyx3aGnx.js";import"./tag-ClhzHHXz.js";import"./ssrBoot-DL-QNHNL.js";import"./VSelect-BDnerYRz.js";import"./VMenu-CzW1lCu_.js";import"./filter-DzHhRroJ.js";const q={name:"CadastroProdutosPage",mixins:[U],setup(){return{authStore:S()}},data(){return{validForm:!1,saving:!1,formRef:null,loadingProduto:!1,produtoId:null,produtoCodigo:"",responsavelCadastroId:null,detalheProduto:null,categorias:[],marcas:[],unidadesMedida:[],fornecedores:[],localizacoes:[],formData:{nome:"",descricao:"",id_categoria:null,id_marca:null,id_unidade_medida:null,estoque_minimo:0,is_perecivel:!1,data_validade:null,custo_unitario:0,quantidade:0,id_localizacao:null,id_fornecedor:null,ativo:!0},custoUnitarioInput:""}},computed:{isEditMode(){return this.produtoId!==null},pageTitle(){return this.isEditMode?"Editar Produto":"Cadastro de Produtos"},submitLabel(){return this.saving?this.isEditMode?"Atualizando...":"Salvando...":this.isEditMode?"Atualizar Produto":"Salvar Produto"},fornecedoresInfo(){return this.detalheProduto?.fornecedores??[]},rules(){return{nome:[C.required,P.minLength(3)],descricao:[C.required,P.minLength(10)],id_categoria:[o=>!!o||"Categoria é obrigatória"],id_marca:[o=>!!o||"Marca é obrigatória"],id_unidade_medida:[o=>!!o||"Unidade de medida é obrigatória"],estoque_minimo:[o=>o>=0||"Estoque mínimo deve ser maior ou igual a 0"],data_validade:[o=>this.formData.is_perecivel?!!o||"Data de validade é obrigatória para produtos perecíveis":!0],custo_unitario:[o=>(typeof o=="number"?o:this.toCents(String(o)))>=0||"Custo unitário não pode ser negativo"],quantidade:[o=>o>=0||"Quantidade não pode ser negativa"],id_localizacao:[()=>!0],id_fornecedor:[()=>!0]}},categoriaOptions(){return this.categorias.map(o=>({title:o.nome,value:o.id}))},marcaOptions(){return this.marcas.map(o=>({title:o.nome,value:o.id}))},unidadeMedidaOptions(){return this.unidadesMedida.map(o=>({title:`${o.descricao} (${o.abreviacao})`,value:o.id}))},fornecedorOptions(){return this.fornecedores.map(o=>({title:o.nome,value:o.id}))},localizacaoOptions(){return this.localizacoes.map(o=>({title:`${o.deposito_nome} - ${o.corredor||""} ${o.prateleira||""} ${o.secao||""}`.trim(),value:o.id}))}},methods:{async carregarProduto(o){this.loadingProduto=!0;try{const e=await h.getDetail(o);this.detalheProduto=e,this.produtoId=e.id,this.produtoCodigo=e.codigo,this.responsavelCadastroId=e.responsavel_cadastro;const n=e.lotes?.[0],v=e.fornecedores?.[0]?.id_fornecedor??null;this.formData={nome:e.nome,descricao:e.descricao??"",id_categoria:e.id_categoria??null,id_marca:e.id_marca??null,id_unidade_medida:e.id_unidade_medida,estoque_minimo:e.estoque_minimo??0,is_perecivel:e.is_perecivel,data_validade:e.is_perecivel?n?.data_validade??null:null,custo_unitario:0,quantidade:n?.quantidade??0,id_localizacao:n?.id_localizacao??null,id_fornecedor:v,ativo:e.ativo},this.custoUnitarioInput=this.formatBRLFromCents(0)}catch(e){console.error("Erro ao carregar produto:",e),this.showError("Erro ao carregar dados do produto"),this.$router.push("/produtos")}finally{this.loadingProduto=!1}},formatBRLFromCents(o){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o/100)},toCents(o){const e=o.replace(/[^\d]/g,"");return parseInt(e)||0},toNumber(o){const e=o.replace(/[^\d,]/g,"").replace(",",".");return parseFloat(e)||0},formatNumber(o){return new Intl.NumberFormat("pt-BR").format(o)},formatDate(o){if(!o)return"-";const e=new Date(o);return Number.isNaN(e.getTime())?"-":e.toLocaleString("pt-BR")},onCustoUnitarioInput(o){const e=this.toCents(o);this.custoUnitarioInput=this.formatBRLFromCents(e),this.formData.custo_unitario=e},async limparFormulario(){if(this.isEditMode&&this.produtoId){await this.carregarProduto(this.produtoId);return}this.formData={nome:"",descricao:"",id_categoria:null,id_marca:null,id_unidade_medida:null,estoque_minimo:0,is_perecivel:!1,data_validade:null,custo_unitario:0,quantidade:0,id_localizacao:null,id_fornecedor:null,ativo:!0},this.custoUnitarioInput="",this.produtoId=null,this.produtoCodigo="",this.responsavelCadastroId=null,this.detalheProduto=null,this.formRef&&this.formRef.reset()},async salvarProduto(){this.saving=!0;try{const o=await this.formRef?.validate?.();if(o&&!o.valid){this.saving=!1;return}const n=z()?.id??1;if(this.isEditMode&&this.produtoId){const l={nome:this.formData.nome,descricao:this.formData.descricao,id_categoria:this.formData.id_categoria??void 0,id_marca:this.formData.id_marca??void 0,id_unidade_medida:this.formData.id_unidade_medida,estoque_minimo:this.formData.estoque_minimo,is_perecivel:this.formData.is_perecivel,responsavel_cadastro:this.responsavelCadastroId??n,usuario_log_id:n,ativo:this.formData.ativo};if(await h.update(this.produtoId,l),this.formData.id_fornecedor)try{await h.linkToSupplier(this.produtoId,this.formData.id_fornecedor,n)}catch(i){console.error("Erro ao vincular produto ao fornecedor:",i),this.showWarning("Produto atualizado, mas houve erro ao vincular fornecedor")}this.showSuccess("Produto atualizado com sucesso!"),this.$router.push("/produtos");return}const v={nome:this.formData.nome,descricao:this.formData.descricao,codigo:"",id_categoria:this.formData.id_categoria,id_marca:this.formData.id_marca,id_unidade_medida:this.formData.id_unidade_medida,estoque_minimo:this.formData.estoque_minimo,is_perecivel:this.formData.is_perecivel,responsavel_cadastro:n,usuario_log_id:n,ativo:this.formData.ativo},r=await h.create(v);if(this.formData.id_fornecedor)try{await h.linkToSupplier(r.id,this.formData.id_fornecedor,n)}catch(l){console.error("Erro ao vincular produto ao fornecedor:",l),this.showWarning("Produto criado, mas houve erro ao vincular fornecedor")}this.showSuccess("Produto cadastrado com sucesso! Agora registre a entrada nas movimentações para gerar o lote."),await this.limparFormulario()}catch(o){console.error("Erro ao salvar produto:",o),this.showError(this.isEditMode?"Erro ao atualizar produto":"Erro ao cadastrar produto")}finally{this.saving=!1}},async loadData(){try{const[o,e,n,v,r]=await Promise.all([R.getAll(),L.getAll(),B.getAll(),O.getAll(),N.getAllComplete()]);this.categorias=o,this.marcas=e,this.unidadesMedida=n,this.fornecedores=v,this.localizacoes=r}catch(o){console.error("Erro ao carregar dados:",o),this.showError("Erro ao carregar dados")}}},async mounted(){await this.loadData();const o=this.$route?.params?.id,e=Number(o);o&&!Number.isNaN(e)&&await this.carregarProduto(e)},watch:{"$route.params.id":{immediate:!1,handler(o){const e=Number(o);o&&!Number.isNaN(e)?this.carregarProduto(e):o||this.limparFormulario()}}}},K={class:"cadastro-produtos-page"},X={class:"d-flex align-center"},Z={class:"d-flex flex-wrap align-center gap-4"},$={key:0},ee={key:1},oe={key:2},ae={class:"d-flex align-center flex-wrap gap-2"},re={class:"d-flex flex-column flex-sm-row justify-center align-center gap-3"},te={class:"d-flex align-center"};function ie(o,e,n,v,r,l){return u(),_("div",K,[a(Q,{fluid:""},{default:t(()=>[a(y,null,{default:t(()=>[a(d,{cols:"12"},{default:t(()=>[a(A,{class:"elevation-8"},{default:t(()=>[a(T,{class:"text-h4 text-center py-6 d-flex align-center justify-space-between"},{default:t(()=>[m("div",X,[a(V,{class:"mr-3",color:"primary",size:"large"},{default:t(()=>[s(c(l.isEditMode?"mdi-pencil":"mdi-package-variant-plus"),1)]),_:1}),s(" "+c(l.pageTitle),1)]),a(b,{icon:"mdi-close",variant:"text",color:"white",size:"large",onClick:e[0]||(e[0]=i=>o.$router.push("/produtos"))})]),_:1}),a(Y,null,{default:t(()=>[r.loadingProduto?(u(),p(j,{key:0,class:"mb-4",color:"primary",indeterminate:""})):f("",!0),r.loadingProduto?f("",!0):(u(),p(W,{key:1,ref:"formRef",modelValue:r.validForm,"onUpdate:modelValue":e[15]||(e[15]=i=>r.validForm=i),onSubmit:M(l.salvarProduto,["prevent"])},{default:t(()=>[a(y,null,{default:t(()=>[l.isEditMode&&r.detalheProduto?(u(),p(d,{key:0,cols:"12"},{default:t(()=>[a(k,{border:"start",color:"info",density:"comfortable",icon:"mdi-information-outline",variant:"tonal"},{default:t(()=>[m("div",Z,[m("div",null,[e[17]||(e[17]=m("strong",null,"Código:",-1)),a(I,{class:"ml-2",color:"primary",size:"small",variant:"flat"},{default:t(()=>[s(c(r.produtoCodigo),1)]),_:1})]),r.detalheProduto?.responsavel_nome?(u(),_("div",$,[e[18]||(e[18]=m("strong",null,"Criado por:",-1)),s(" "+c(r.detalheProduto.responsavel_nome),1)])):f("",!0),r.detalheProduto?.created_at?(u(),_("div",ee,[e[19]||(e[19]=m("strong",null,"Criado em:",-1)),s(" "+c(l.formatDate(r.detalheProduto.created_at)),1)])):f("",!0),r.detalheProduto?.updated_at?(u(),_("div",oe,[e[20]||(e[20]=m("strong",null,"Última atualização:",-1)),s(" "+c(l.formatDate(r.detalheProduto.updated_at)),1)])):f("",!0)])]),_:1})]),_:1})):f("",!0),l.isEditMode?(u(),p(d,{key:1,cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{"model-value":r.produtoCodigo,label:"Código do Produto","prepend-inner-icon":"mdi-identifier",variant:"outlined",readonly:""},null,8,["model-value"])]),_:1})):f("",!0),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.formData.nome,"onUpdate:modelValue":e[1]||(e[1]=i=>r.formData.nome=i),rules:l.rules.nome,label:"Nome do Produto",placeholder:"Digite o nome do produto","prepend-inner-icon":"mdi-package-variant",variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.formData.descricao,"onUpdate:modelValue":e[2]||(e[2]=i=>r.formData.descricao=i),rules:l.rules.descricao,label:"Descrição",placeholder:"Descreva o produto","prepend-inner-icon":"mdi-text",variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(D,{modelValue:r.formData.id_categoria,"onUpdate:modelValue":e[3]||(e[3]=i=>r.formData.id_categoria=i),items:l.categoriaOptions,rules:l.rules.id_categoria,label:"Categoria",placeholder:"Selecione a categoria","prepend-inner-icon":"mdi-tag",variant:"outlined",required:""},null,8,["modelValue","items","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(D,{modelValue:r.formData.id_marca,"onUpdate:modelValue":e[4]||(e[4]=i=>r.formData.id_marca=i),items:l.marcaOptions,rules:l.rules.id_marca,label:"Marca",placeholder:"Selecione a marca","prepend-inner-icon":"mdi-tag-multiple",variant:"outlined",required:""},null,8,["modelValue","items","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(D,{modelValue:r.formData.id_unidade_medida,"onUpdate:modelValue":e[5]||(e[5]=i=>r.formData.id_unidade_medida=i),items:l.unidadeMedidaOptions,rules:l.rules.id_unidade_medida,label:"Unidade de Medida",placeholder:"Selecione a unidade","prepend-inner-icon":"mdi-scale",variant:"outlined",required:""},null,8,["modelValue","items","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.formData.estoque_minimo,"onUpdate:modelValue":e[6]||(e[6]=i=>r.formData.estoque_minimo=i),modelModifiers:{number:!0},rules:l.rules.estoque_minimo,label:"Estoque Mínimo",placeholder:"0","prepend-inner-icon":"mdi-warehouse",type:"number",variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1}),a(d,{cols:"12"},{default:t(()=>[a(G,{modelValue:r.formData.is_perecivel,"onUpdate:modelValue":e[7]||(e[7]=i=>r.formData.is_perecivel=i),label:"Produto Perecível",color:"primary"},null,8,["modelValue"])]),_:1}),r.formData.is_perecivel?(u(),p(d,{key:2,cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.formData.data_validade,"onUpdate:modelValue":e[8]||(e[8]=i=>r.formData.data_validade=i),rules:l.rules.data_validade,label:"Data de Validade",placeholder:"YYYY-MM-DD","prepend-inner-icon":"mdi-calendar",type:"date",variant:"outlined",required:""},null,8,["modelValue","rules"])]),_:1})):f("",!0),a(d,{cols:"12"},{default:t(()=>[a(k,{border:"start",color:"info",density:"comfortable",icon:"mdi-information-outline",variant:"tonal"},{default:t(()=>[...e[21]||(e[21]=[s(" Os campos a seguir são apenas para referência. O lote inicial será criado automaticamente quando você registrar a ",-1),m("strong",null,"entrada",-1),s(" na tela de movimentação. ",-1)])]),_:1})]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.custoUnitarioInput,"onUpdate:modelValue":[e[9]||(e[9]=i=>r.custoUnitarioInput=i),l.onCustoUnitarioInput],rules:l.rules.custo_unitario,label:"Custo Unitário",placeholder:"R$ 0,00","prepend-inner-icon":"mdi-currency-usd",variant:"outlined","persistent-hint":"",hint:"Informativo – será utilizado ao registrar a entrada"},null,8,["modelValue","rules","onUpdate:modelValue"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(g,{modelValue:r.formData.quantidade,"onUpdate:modelValue":e[10]||(e[10]=i=>r.formData.quantidade=i),modelModifiers:{number:!0},rules:l.rules.quantidade,label:"Quantidade",placeholder:"0","prepend-inner-icon":"mdi-counter",type:"number",variant:"outlined","persistent-hint":"",hint:"Valor sugerido para a primeira entrada"},null,8,["modelValue","rules"])]),_:1}),a(d,{cols:"12",sm:"6",md:"6",lg:"6"},{default:t(()=>[a(D,{modelValue:r.formData.id_localizacao,"onUpdate:modelValue":e[11]||(e[11]=i=>r.formData.id_localizacao=i),items:l.localizacaoOptions,rules:l.rules.id_localizacao,label:"Localização",placeholder:"Selecione a localização","prepend-inner-icon":"mdi-map-marker",variant:"outlined","persistent-hint":"",hint:"Escolha onde pretende armazenar na entrada"},null,8,["modelValue","items","rules"])]),_:1}),a(d,{cols:"12"},{default:t(()=>[a(D,{modelValue:r.formData.id_fornecedor,"onUpdate:modelValue":e[12]||(e[12]=i=>r.formData.id_fornecedor=i),items:l.fornecedorOptions,rules:l.rules.id_fornecedor,label:"Fornecedor",placeholder:"Selecione o fornecedor","prepend-inner-icon":"mdi-truck",variant:"outlined","persistent-hint":"",hint:"Opcional – vincula o produto ao fornecedor"},null,8,["modelValue","items","rules"])]),_:1}),l.isEditMode&&l.fornecedoresInfo.length?(u(),p(d,{key:3,cols:"12"},{default:t(()=>[m("div",ae,[e[22]||(e[22]=m("span",{class:"text-caption text-grey-lighten-1"},"Fornecedores já vinculados:",-1)),(u(!0),_(x,null,F(l.fornecedoresInfo,i=>(u(),p(I,{key:i.id_fornecedor,class:"mr-2 mb-2",color:"primary",size:"small",variant:"tonal"},{default:t(()=>[s(c(i.nome),1)]),_:2},1024))),128))])]),_:1})):f("",!0),a(d,{cols:"12"},{default:t(()=>[a(H,{modelValue:r.formData.ativo,"onUpdate:modelValue":e[13]||(e[13]=i=>r.formData.ativo=i),color:"success",inset:"",label:"Produto ativo"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{class:"mt-6"},{default:t(()=>[a(d,{cols:"12",class:"text-center"},{default:t(()=>[m("div",re,[a(b,{color:"primary",disabled:!r.validForm||r.saving,loading:r.saving,size:"large",type:"submit",variant:"elevated",class:"flex-grow-1 flex-sm-grow-0"},{default:t(()=>[a(V,{class:"mr-2"},{default:t(()=>[s(c(l.isEditMode?"mdi-content-save-edit":"mdi-content-save"),1)]),_:1}),s(" "+c(l.submitLabel),1)]),_:1},8,["disabled","loading"]),a(b,{color:"grey",size:"large",variant:"outlined",class:"flex-grow-1 flex-sm-grow-0",onClick:l.limparFormulario},{default:t(()=>[a(V,{class:"mr-2"},{default:t(()=>[...e[23]||(e[23]=[s("mdi-refresh",-1)])]),_:1}),e[24]||(e[24]=s(" Limpar ",-1))]),_:1},8,["onClick"]),a(b,{color:"error",size:"large",variant:"outlined",class:"flex-grow-1 flex-sm-grow-0",onClick:e[14]||(e[14]=i=>o.$router.push("/produtos"))},{default:t(()=>[a(V,{class:"mr-2"},{default:t(()=>[...e[25]||(e[25]=[s("mdi-close",-1)])]),_:1}),e[26]||(e[26]=s(" Cancelar ",-1))]),_:1})])]),_:1})]),_:1})]),_:1},8,["modelValue","onSubmit"]))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(J,{modelValue:o.snackbar,"onUpdate:modelValue":e[16]||(e[16]=i=>o.snackbar=i),color:o.snackbarColor,elevation:"8",location:"top right",timeout:o.snackbarTimeout},{default:t(()=>[m("div",te,[a(V,{class:"mr-2",icon:o.snackbarColor==="success"?"mdi-check-circle":"mdi-alert-circle"},null,8,["icon"]),s(" "+c(o.snackbarText),1)])]),_:1},8,["modelValue","color","timeout"])])}typeof w=="function"&&w(q);const Ie=E(q,[["render",ie],["__scopeId","data-v-4f7e5bd2"]]);export{Ie as default};
