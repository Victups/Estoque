import{a as z,A as R}from"./uf.service-Bn8JpA_W.js";import{P as Y,L as j}from"./product.service-DE7QUhp7.js";import{u as Se,a as ke,b as Ce,c as be,m as Ee}from"./VSelect-DK1SXm7i.js";import{p as Fe,q as Pe,V as G,r as De,l as J,k as Ie,s as Le,h as Me,t as ze}from"./VTextField-BR1_iDts.js";import{k as Re,d as Q,e as Te,l as Be,n as Ne}from"./VCard-Cmc6vJ8q.js";import{u as Oe,h as Ke,m as Ue}from"./filter-B-yaYJPB.js";import{i as $e,p as qe,k as He,y as T,z as P,x as H,m as We,l as A,C as B,I as Z,S as Xe,n as Ye,a as w,b as C,T as je,F as W,q as x,U as Ge,R as Je,v as Qe,e as Ze,V as et,W as ee,X as tt,Y as te}from"./index-Dh7kI4jI.js";import{V as at}from"./VMenu-x2Orytf9.js";import{V as lt}from"./VChip-DgJE4qLc.js";class ot{endpoint="/produto_lotes";async getAll(){try{const r=await z.get(this.endpoint);return new R(r.data).get()}catch{throw new Error("Erro ao buscar lotes")}}async getAllEnriched(){try{const[r,l,c]=await Promise.all([this.getAll(),Y.getAll(),j.getAll()]),u=new Map(l.map(i=>[i.id,i])),d=new Map(c.map(i=>[i.id,i]));return r.map(i=>{const _=u.get(i.id_produto),f=i.id_localizacao?d.get(i.id_localizacao):null;return{...i,produto_nome:_?.nome,produto_codigo:_?.codigo,localizacao_nome:f?`${f.corredor} - ${f.prateleira} - ${f.secao}`:void 0}})}catch{throw new Error("Erro ao buscar lotes enriquecidos")}}async getAllComplete(r){try{const[l,c,u]=await Promise.all([this.getAll(),Y.getAll(),j.getAllComplete(r)]),d=new Map(c.map(f=>[f.id,f])),i=new Map(u.map(f=>[f.id,f]));return l.filter(f=>r!=null?(f.id_localizacao?i.get(f.id_localizacao):null)?.uf_id===r:!0).map(f=>{const S=d.get(f.id_produto),n=f.id_localizacao?i.get(f.id_localizacao):null;return{...f,produto_nome:S?.nome,produto_codigo:S?.codigo,localizacao_corredor:n?.corredor,localizacao_prateleira:n?.prateleira,localizacao_secao:n?.secao,deposito_nome:n?.deposito_nome,endereco_completo:n?.endereco_completo,endereco_cep:n?.endereco_cep,municipio_nome:n?.municipio_nome,municipio_bairro:n?.municipio_bairro,uf_sigla:n?.uf_sigla,uf_nome:n?.uf_nome,uf_id:n?.uf_id,localizacao_completa:n?.localizacao_completa}})}catch{throw new Error("Erro ao buscar lotes completos")}}async getById(r){return(await this.getAll()).find(c=>c.id===r)}async getByProduct(r){return(await this.getAll()).filter(c=>c.id_produto===r)}async getAvailableByProductFIFO(r){return(await this.getByProduct(r)).filter(u=>u.quantidade>0).sort((u,d)=>new Date(u.data_validade).getTime()-new Date(d.data_validade).getTime())}async getByLocation(r){return(await this.getAll()).filter(c=>c.id_localizacao===r)}async getExpiringSoon(r=30){const l=await this.getAll(),c=new Date,u=new Date;return u.setDate(c.getDate()+r),l.filter(d=>{const i=new Date(d.data_validade);return i>=c&&i<=u})}async create(r){const l=await this.getAll(),c=l.length>0?Math.max(...l.map(i=>i.id))+1:1,u=r.codigo_lote&&r.codigo_lote.trim()!==""?r.codigo_lote:`L${c.toString().padStart(3,"0")}`,d={...r,id:c,codigo_lote:u};l.push(d);try{return await z.put(this.endpoint,new R(l).toNestedArray()),d}catch{throw new Error("Erro ao criar lote")}}async update(r,l){const c=await this.getAll(),u=c.findIndex(_=>_.id===r);if(u===-1)throw new Error("Lote não encontrado");const d=c[u];if(!d)throw new Error("Lote não encontrado");const i={...d,...l,id:d.id};c[u]=i;try{return await z.put(this.endpoint,new R(c).toNestedArray()),i}catch{throw new Error("Erro ao atualizar lote")}}async delete(r){const c=(await this.getAll()).filter(u=>u.id!==r);try{await z.put(this.endpoint,new R(c).toNestedArray())}catch{throw new Error("Erro ao excluir lote")}}}const pt=new ot,nt=qe({autoSelectFirst:{type:[Boolean,String]},clearOnSelect:Boolean,search:String,...Ue({filterKeys:["title"]}),...Ee(),...et(ze({modelValue:null,role:"combobox"}),["validationValue","dirty","appendInnerIcon"]),...Ne({transition:!1})},"VAutocomplete"),ht=$e()({name:"VAutocomplete",props:nt(),emits:{"update:focused":t=>!0,"update:search":t=>!0,"update:modelValue":t=>!0,"update:menu":t=>!0},setup(t,r){let{slots:l}=r;const{t:c}=He(),u=T(),d=P(!1),i=P(!0),_=P(!1),f=T(),S=T(),n=P(-1),{items:N,transformIn:ae,transformOut:le}=Fe(t),{textColorClasses:oe,textColorStyles:ne}=Re(()=>u.value?.color),h=H(t,"search",""),s=H(t,"modelValue",[],e=>ae(e===null?[null]:We(e)),e=>{const v=le(e);return t.multiple?v:v[0]??null}),ue=A(()=>typeof t.counterValue=="function"?t.counterValue(s.value):typeof t.counterValue=="number"?t.counterValue:s.value.length),D=Pe(t),{filteredItems:O,getMatches:ie}=Oe(t,N,()=>i.value?"":h.value),V=A(()=>t.hideSelected?O.value.filter(e=>!s.value.some(v=>v.value===e.value)):O.value),I=A(()=>!!(t.chips||l.chip)),b=A(()=>I.value||!!l.selection),re=A(()=>s.value.map(e=>e.props.value)),K=A(()=>(t.autoSelectFirst===!0||t.autoSelectFirst==="exact"&&h.value===V.value[0]?.title)&&V.value.length>0&&!i.value&&!_.value),L=A(()=>t.hideNoData&&!V.value.length||D.isReadonly.value||D.isDisabled.value),U=H(t,"menu"),m=A({get:()=>U.value,set:e=>{U.value&&!e&&f.value?.ΨopenChildren.size||e&&L.value||(U.value=e)}}),{menuId:se,ariaExpanded:ce,ariaControls:de,ariaLabel:X}=Se(t,m),$=T(),ve=ke($,u);function fe(e){t.openOnClear&&(m.value=!0),h.value=""}function me(){L.value||(m.value=!0)}function pe(e){L.value||(d.value&&(e.preventDefault(),e.stopPropagation()),m.value=!m.value)}function he(e){(ee(e)||e.key==="Backspace")&&u.value?.focus()}function ge(e){if(D.isReadonly.value)return;const v=u.value?.selectionStart,p=s.value.length;if(["Enter","ArrowDown","ArrowUp"].includes(e.key)&&e.preventDefault(),["Enter","ArrowDown"].includes(e.key)&&(m.value=!0),["Escape"].includes(e.key)&&(m.value=!1),K.value&&["Enter","Tab"].includes(e.key)&&!s.value.some(o=>{let{value:a}=o;return a===V.value[0].value})&&k(V.value[0]),e.key==="ArrowDown"&&K.value&&$.value?.focus("next"),["Backspace","Delete"].includes(e.key)){if(!t.multiple&&b.value&&s.value.length>0&&!h.value)return k(s.value[0],!1);if(~n.value){e.preventDefault();const o=n.value;k(s.value[n.value],!1),n.value=o>=p-1?p-2:o}else e.key==="Backspace"&&!h.value&&(n.value=p-1);return}if(t.multiple)if(e.key==="ArrowLeft"){if(n.value<0&&v&&v>0)return;const o=n.value>-1?n.value-1:p-1;if(s.value[o])n.value=o;else{const a=h.value?.length??null;n.value=-1,u.value?.setSelectionRange(a,a)}}else if(e.key==="ArrowRight"){if(n.value<0)return;const o=n.value+1;s.value[o]?n.value=o:(n.value=-1,u.value?.setSelectionRange(0,0))}else~n.value&&ee(e)&&(n.value=-1)}function we(e){if(te(u.value,":autofill")||te(u.value,":-webkit-autofill")){const v=N.value.find(p=>p.title===e.target.value);v&&k(v)}}function ye(){t.eager&&S.value?.calculateVisibleItems()}function _e(){d.value&&(i.value=!0,u.value?.focus())}function Ve(e){d.value=!0,setTimeout(()=>{_.value=!0})}function Ae(e){_.value=!1}function xe(e){(e==null||e===""&&!t.multiple&&!b.value)&&(s.value=[])}const q=P(!1);function k(e){let v=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(!(!e||e.props.disabled))if(t.multiple){const p=s.value.findIndex(a=>(t.valueComparator||tt)(a.value,e.value)),o=v??!~p;if(~p){const a=o?[...s.value,e]:[...s.value];a.splice(p,1),s.value=a}else o&&(s.value=[...s.value,e]);t.clearOnSelect&&(h.value="")}else{const p=v!==!1;s.value=p?[e]:[],h.value=p&&!b.value?e.title:"",Z(()=>{m.value=!1,i.value=!0})}}return B(d,(e,v)=>{e!==v&&(e?(q.value=!0,h.value=t.multiple||b.value?"":String(s.value.at(-1)?.props.title??""),i.value=!0,Z(()=>q.value=!1)):(!t.multiple&&h.value==null&&(s.value=[]),m.value=!1,h.value="",n.value=-1))}),B(h,e=>{!d.value||q.value||(e&&(m.value=!0),i.value=!e)}),B(m,()=>{if(!t.hideSelected&&m.value&&s.value.length){const e=V.value.findIndex(v=>s.value.some(p=>v.value===p.value));Xe&&window.requestAnimationFrame(()=>{e>=0&&S.value?.scrollToIndex(e)})}}),B(N,(e,v)=>{m.value||d.value&&!v.length&&e.length&&(m.value=!0)}),Ye(()=>{const e=!!(!t.hideNoData||V.value.length||l["prepend-item"]||l["append-item"]||l["no-data"]),v=s.value.length>0,p=G.filterProps(t);return w(G,x({ref:u},p,{modelValue:h.value,"onUpdate:modelValue":[o=>h.value=o,xe],focused:d.value,"onUpdate:focused":o=>d.value=o,validationValue:s.externalValue,counterValue:ue.value,dirty:v,onChange:we,class:["v-autocomplete",`v-autocomplete--${t.multiple?"multiple":"single"}`,{"v-autocomplete--active-menu":m.value,"v-autocomplete--chips":!!t.chips,"v-autocomplete--selection-slot":!!b.value,"v-autocomplete--selecting-index":n.value>-1},t.class],style:t.style,readonly:D.isReadonly.value,placeholder:v?void 0:t.placeholder,"onClick:clear":fe,"onMousedown:control":me,onKeydown:ge,"aria-expanded":ce.value,"aria-controls":de.value}),{...l,default:()=>C(W,null,[w(at,x({id:se.value,ref:f,modelValue:m.value,"onUpdate:modelValue":o=>m.value=o,activator:"parent",contentClass:"v-autocomplete__content",disabled:L.value,eager:t.eager,maxHeight:310,openOnClick:!1,closeOnContentClick:!1,transition:t.transition,onAfterEnter:ye,onAfterLeave:_e},t.menuProps),{default:()=>[e&&w(De,x({ref:$,filterable:!0,selected:re.value,selectStrategy:t.multiple?"independent":"single-independent",onMousedown:o=>o.preventDefault(),onKeydown:he,onFocusin:Ve,onFocusout:Ae,tabindex:"-1",selectable:!0,"aria-live":"polite",color:t.itemColor??t.color},ve,t.listProps),{default:()=>[l["prepend-item"]?.(),!V.value.length&&!t.hideNoData&&(l["no-data"]?.()??w(J,{key:"no-data",title:c(t.noDataText)},null)),w(Ce,{ref:S,renderless:!0,items:V.value,itemKey:"value"},{default:o=>{let{item:a,index:g,itemRef:M}=o;const E=x(a.props,{ref:M,key:a.value,active:K.value&&g===0?!0:void 0,onClick:()=>k(a,null)});return a.type==="divider"?l.divider?.({props:a.raw,index:g})??w(Ie,x(a.props,{key:`divider-${g}`}),null):a.type==="subheader"?l.subheader?.({props:a.raw,index:g})??w(Le,x(a.props,{key:`subheader-${g}`}),null):l.item?.({item:a,index:g,props:E})??w(J,x(E,{role:"option"}),{prepend:F=>{let{isSelected:y}=F;return C(W,null,[t.multiple&&!t.hideSelected?w(be,{key:a.value,modelValue:y,ripple:!1,tabindex:"-1"},null):void 0,a.props.prependAvatar&&w(Te,{image:a.props.prependAvatar},null),a.props.prependIcon&&w(Q,{icon:a.props.prependIcon},null)])},title:()=>i.value?a.title:Ke("v-autocomplete",a.title,ie(a)?.title)})}}),l["append-item"]?.()]})]}),s.value.map((o,a)=>{function g(y){y.stopPropagation(),y.preventDefault(),k(o,!1)}const M={"onClick:close":g,onKeydown(y){y.key!=="Enter"&&y.key!==" "||(y.preventDefault(),y.stopPropagation(),g(y))},onMousedown(y){y.preventDefault(),y.stopPropagation()},modelValue:!0,"onUpdate:modelValue":void 0},E=I.value?!!l.chip:!!l.selection,F=E?Ge(I.value?l.chip({item:o,index:a,props:M}):l.selection({item:o,index:a})):void 0;if(!(E&&!F))return C("div",{key:o.value,class:Qe(["v-autocomplete__selection",a===n.value&&["v-autocomplete__selection--selected",oe.value]]),style:Je(a===n.value?ne.value:{})},[I.value?l.chip?w(Be,{key:"chip-defaults",defaults:{VChip:{closable:t.closableChips,size:"small",text:o.title}}},{default:()=>[F]}):w(lt,x({key:"chip",closable:t.closableChips,size:"small",text:o.title,disabled:o.props.disabled},M),null):F??C("span",{class:"v-autocomplete__selection-text"},[o.title,t.multiple&&a<s.value.length-1&&C("span",{class:"v-autocomplete__selection-comma"},[Ze(",")])])])})]),"append-inner":function(){for(var o=arguments.length,a=new Array(o),g=0;g<o;g++)a[g]=arguments[g];return C(W,null,[l["append-inner"]?.(...a),t.menuIcon?w(Q,{class:"v-autocomplete__menu-icon",color:u.value?.fieldIconColor,icon:t.menuIcon,onMousedown:pe,onClick:je,"aria-label":X.value,title:X.value,tabindex:"-1"},null):void 0])}})}),Me({isFocused:d,isPristine:i,menu:m,search:h,filteredItems:O,select:k},u)}});export{pt as L,ht as V};
